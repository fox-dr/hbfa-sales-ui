<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/x-icon" href="hbfa.ico">
  <title>Fusion Offer Form</title>

  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Lato', sans-serif;
      margin: 20px;
      background-color: #fdfdfd;
      color: #333;
    }
    header, footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    header img, footer img {
      height: 60px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }
    fieldset {
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 6px;
      background-color: #fff;
    }
    legend {
      font-weight: 700;
      font-size: 1.2em;
      margin-bottom: 10px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      align-items: flex-end;
    }
    .row > label {
      flex: 1;
      min-width: 200px;
    }
    .unit-group {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    .unit-group label {
      margin: 0;
    }
    label {
      display: flex;
      flex-direction: column;
      font-size: 0.95rem;
    }
    input, textarea, select {
      padding: 10px;
      font-family: inherit;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 6px;
      box-sizing: border-box;
    }
    input[name="buyer_name"] {
      width: 100%;
      max-width: 600px;
    }
    input[name="unit_number"] {
      width: 80px;
    }
    input[name="address_1"], input[name="address_2"] {
      width: 100%;
    }
    input[name="state"] {
      width: 50px;
    }
    input[name="zip_code"] {
      width: 80px;
    }
    textarea {
      resize: vertical;
    }
    .readonly-field {
      background-color: #f0f0f0;
    }
    .pdf-button {
      margin-top: 10px;
    }
    button {
      padding: 10px 18px;
      font-size: 1rem;
      background-color: #00526d;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #003f52;
    }
    footer {
      margin-top: 40px;
    }
    p {
      font-size: 0.9rem;
      line-height: 1.5;
    }
  </style>
</head>
<body>

<header>
  <h2>Preliminary Offer</h2>
  <img src="/assets/fusion_logo.png" alt="Fusion Logo">
</header>

<form id="offerForm">

  <fieldset>
    <legend>Buyer Contact Information</legend>
    <div class="row" style="align-items: flex-start;">
      <label style="flex: 2;">Name (As on Contract)<input type="text" name="buyer_name" maxlength="50"></label>
      <div class="unit-group" style="flex: 1;">
        <label>Unit Number<input type="number" name="unit_number" min="1" max="55"></label>
        <button type="button" id="select_unit">Select Unit</button>
      </div>
    </div>
    <div class="row">
      <label>Current Street Address *<input type="text" name="address_1" required></label>
      <label>(Suite / Apt / PO Box)<input type="text" name="address_2"></label>
    </div>
    <div class="row">
      <label>City *<input type="text" name="city" maxlength="35" required></label>
      <label>State *<input type="text" name="state" maxlength="2" required></label>
      <label style="margin-left: -10px;">Zip Code *<input type="text" name="zip_code" maxlength="10" required></label>
    </div>
    <div class="row">
      <label>Phone Number 1<input type="tel" name="phone_number_1" maxlength="20"></label>
      <label>Phone Number 2<input type="tel" name="phone_number_2" maxlength="20"></label>
      <label>Phone Number 3<input type="tel" name="phone_number_3" maxlength="20"></label>
    </div>
    <div class="row">
      <label>Email 1<input type="email" name="email_1" maxlength="40"></label>
      <label>Email 2<input type="email" name="email_2" maxlength="40"></label>
      <label>Email 3<input type="email" name="email_3" maxlength="40"></label>
    </div>
    <div class="row">
      <label style="flex: 1 1 100%;">Buyer Notes<textarea name="buyer_notes" rows="4" maxlength="512" style="width: 100%;"></textarea></label>
    </div>
  </fieldset>

  <fieldset>
    <legend>Offer Information</legend>
    <div class="row">
      <label>Lender Institution<input type="text" name="lender"></label>
      <label>Loan Officer<input type="text" name="loan_officer"></label>
      <label>Loan Officer Email<input type="email" name="l_o_contact_email" maxlength="40"></label>
      <label>Loan Officer Phone<input type="tel" name="l_o_phone" maxlength="20"></label>
    </div>
    <div class="row">
      <label>Broker Name<input type="text" name="broker_name"></label>
      <label>Brokerage<input type="text" name="brokerage"></label>
      <label>Broker Email<input type="email" name="broker_email" maxlength="40"></label>
      <label>Broker Phone<input type="tel" name="broker_phone" maxlength="20"></label>
    </div>
    <div class="row">
      <label><input type="checkbox" name="cash_purchase"> Cash Purchase?</label>
      <label>Price<input type="number" name="price" step="0.01"></label>
      <label>Purchase Type
        <select name="purchase_type">
          <option value="">Select...</option>
          <option value="personal_residence">Personal Residence</option>
          <option value="investment_property">Investment Property</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label style="flex: 1 1 100%;">Qualification/Lender Notes<textarea name="offer_notes_1" rows="3" maxlength="512" style="width: 100%;"></textarea></label>
    </div>
  </fieldset>

  <fieldset>
    <legend>Home Details (From Fusion)</legend>
    <div class="row">
      <label style="flex: 1;">Building Info
        <input type="text" id="building_info" name="building_info" class="readonly-field" readonly>
      </label>
      <label style="flex: 1;">Plan Info
        <input type="text" id="plan_info" name="plan_info" class="readonly-field" readonly>
      </label>
      <label style="flex: 1;">Address
        <input type="text" id="address_info" name="address_info" class="readonly-field" readonly>
      </label>
      <div style="align-self: flex-end;"><button type="button" id="pdf_link" class="pdf-button" disabled>Open PDF</button></div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Additional Notes</legend>
    <textarea name="add_notes" rows="5" style="width: 100%;"></textarea>
  </fieldset>

  <fieldset>
    <legend>Boilerplate</legend>
    <p>THIS IS NOT A CONTRACT. THE TERMS OF THIS PRELIMINARY OFFER ARE NON-BINDING...</p>
  </fieldset>

  <fieldset>
    <legend>Signatures (DocuSign Placeholder)</legend>
    <div class="row">
      <label>Signature 1<input type="text" name="signature_1"></label>
      <label>Date<input type="text" name="sig_1_date"></label>
      <label>Signature 2<input type="text" name="signature_2"></label>
      <label>Date<input type="text" name="sig_2_date"></label>
    </div>
  </fieldset>

  <button type="submit">Submit Offer</button>
</form>

<footer>
  <div></div>
  <img src="company_logo.png" alt="Company Logo">
</footer>

<script>
const API_BASE = "https://lyj4zmurck.execute-api.us-east-2.amazonaws.com/prod";

document.getElementById("select_unit").addEventListener("click", async () => {
  const unitNum = document.querySelector("input[name='unit_number']").value?.trim();
  if (!unitNum) return alert("Enter a unit number");

  const setFields = (obj = {}) => {
    const building = obj.building_info || (obj.building_ID ? `Building ${obj.building_ID} / Unit ${obj.unit_number ?? ''}` : "");
    const plan = obj.plan_info || obj.plan_type || "";
    const addr = obj.address || obj.address_line || obj.addr || "";

    document.getElementById("building_info").value = building;
    document.getElementById("plan_info").value = plan;
    document.getElementById("address_info").value = addr;

    const pdfBtn = document.getElementById("pdf_link");
    if (obj.pdf_url) {
      pdfBtn.disabled = false;
      pdfBtn.onclick = () => window.open(obj.pdf_url, "_blank");
    } else {
      pdfBtn.disabled = true;
      pdfBtn.onclick = null;
    }
  };

  try {
    // 1) Try the dedicated unit_info_v2 endpoint first
    const v2 = await fetch(`${API_BASE}/unit_info_v2?unit_number=${encodeURIComponent(unitNum)}`);
    if (v2.ok) {
      const data = await v2.json();
      // Handle array or single object payloads
      const record = Array.isArray(data) ? data[0] : data;
      if (record) {
        setFields(record);
        return;
      }
    }
  } catch (e) {
    console.warn("unit_info_v2 not available, falling back to /units", e);
  }

  try {
    // 2) Fallback: use the /units list and find by unit_number
    const res = await fetch(`${API_BASE}/units`);
    if (!res.ok) throw new Error(`Units fetch failed: ${res.status}`);
    const units = await res.json();
    const unit = Array.isArray(units) ? units.find(u => String(u.unit_number) === String(unitNum)) : null;
    if (unit) {
      setFields(unit);
    } else {
      alert("Unit not found");
    }
  } catch (err) {
    console.error(err);
    alert("Error fetching unit info");
  }
});

document.getElementById("offerForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());
  try {
    const res = await fetch(`${API_BASE}/offers`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const result = await res.json();
    alert(result.message || JSON.stringify(result));
  } catch (err) {
    console.error(err);
    alert("Error submitting offer");
  }
});
</script>

</body>
</html>
